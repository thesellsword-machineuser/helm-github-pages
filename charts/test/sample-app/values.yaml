common: &common
  envFrom:
    sample-app-env:
      configMapRef:
        name: sample-app-env

configmaps:
  sample-app-env:
    metadata:
      name: sample-app-env
      helm_sh_annotations:
        helm_sh_hook: pre-install
        helm_sh_hook_weight: "-1"
        helm_sh_hook_delete_policy: before-hook-creation
    data:
      - KEY1:
          name: KEY1
          value: VALUE1
      - KEY2:
          name: KEY2
          value: VALUE2
      - KEY3:
          name: KEY3
          value: VALUE3

jobs:
  sample-app-job:
    metadata:
      name: sample-app-job
      annotations:
        key1: value1
        key2: value2
      helm_sh_annotations:
        helm_sh_hook: pre-install
        helm_sh_hook_weight: "0"
        helm_sh_hook_delete_policy: before-hook-creation
    spec:
      parallelism: 1
      completions: 1
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          containers:
            sample-app-job:
              <<: *common
              name: sample-app-job
              image:
                repository: sample-app
                tag: latest
                pullPolicy: Always
                command: ["/bin/sh"]
                args:
                  - "-c"
                  - "echo \"Hello World\""
              resources:
                requests:
                  cpu: "1"
                  memory: 1024Mi
                limits:
                  cpu: "1"
                  memory: 1024Mi

deployments:
  sample-app:
    metadata:
      name: sample-app
      labels:
        key: value
      annotations:
        prefix.svc.com/annotation1: 'true'
        prefix.svc.com/annotation2: 'false'
    replicaCount: 3
    deploymentStrategy:
      type: RollingUpdate
    restartPolicy: Always
    containers:
      sample-app:
        <<: *common
        name: sample-app
        image:
          repository: sample-app
          tag: latest
          pullPolicy: Always
        ports:
          https:
            name: https
            protocol: TCP
            containerPort: "3000"
        resources:
          requests:
            cpu: "1"
            memory: 2048Mi
          limits:
            cpu: "1"
            memory: 4096Mi

ingress:
  enabled: true
  metadata:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
      acme.cert-manager.io/http01-edit-in-place: "true"
  tls:
    - hosts:
      - 'sample-app.example.com'
      secretName: ingress-tls-secret
  rules:
    - host: 'sample-app.example.com'
      http:
        paths:
          - path:
            backend:
              serviceName: sample-app
              servicePort: 443

services:
  sample-app:
    selector:
      name: sample-app
    metadata:
      name: sample-app
    ports:
      - name: http
        port: "80"
        protocol: TCP
        targetPort: "3000"

